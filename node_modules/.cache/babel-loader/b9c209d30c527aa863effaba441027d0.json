{"remainingRequest":"/Users/huangpei-yu/Front-Gym/node_modules/babel-loader/lib/index.js!/Users/huangpei-yu/Front-Gym/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/huangpei-yu/Front-Gym/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/huangpei-yu/Front-Gym/src/components/Comments.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/huangpei-yu/Front-Gym/src/components/Comments.vue","mtime":1580814330250},{"path":"/Users/huangpei-yu/Front-Gym/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/huangpei-yu/Front-Gym/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/huangpei-yu/Front-Gym/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/huangpei-yu/Front-Gym/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.function.name\";\nimport _parseFloat from \"/Users/huangpei-yu/Front-Gym/node_modules/@babel/runtime-corejs2/core-js/parse-float\";\nimport _Date$now from \"/Users/huangpei-yu/Front-Gym/node_modules/@babel/runtime-corejs2/core-js/date/now\";\nimport \"core-js/modules/web.dom.iterable\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport { fb, db } from \"@/firebase/init\";\nimport StarRating from \"vue-star-rating\";\nimport Swal from \"sweetalert2\";\nimport moment from \"moment\";\nexport default {\n  components: {\n    StarRating: StarRating\n  },\n  data: function data() {\n    return {\n      avgStarRating: null,\n      ratings: [],\n      ratingsSorted: [0, 0, 0, 0, 0],\n      ratingsPercent: null,\n      user: {},\n      commentTo: [],\n      comments: [],\n      comment: {\n        comment: null,\n        rating: null,\n        user: null,\n        timestamp: null,\n        toId: null,\n        cat: null\n      },\n      feedback: null,\n      inputstatus: \"新留言\",\n      inputShow: false\n    };\n  },\n  props: [\"courseId\", \"courseCat\"],\n  firestore: function firestore() {\n    var _this = this;\n\n    return {\n      //更新課程評價時使用\n      course: {\n        ref: db.collection(\"courses\").doc(this.courseId),\n        resolve: function resolve(data) {\n          data.forEach(function (doc) {\n            return _this.ratings.push(doc.rating);\n          }); //計算初始平均評價\n\n          _this.avgRating();\n        }\n      },\n      //更新評價時使用\n      comments: db.collection(\"comments\"),\n      commentTo: {\n        ref: db.collection(\"comments\").where(\"toId\", \"==\", this.courseId),\n        resolve: function resolve(data) {\n          data.forEach(function (doc) {\n            return _this.ratings.push(doc.rating);\n          }); //計算初始平均評價\n\n          _this.avgRating();\n        }\n      }\n    };\n  },\n  methods: {\n    time: function time(num) {\n      return moment(num).format(\"YYYY/MM/DD HH:mm\");\n    },\n    addComment: function addComment() {\n      if (this.comment.rating) {\n        //新增評價分數\n        this.ratings.push(this.comment.rating); //計算平均評價\n\n        this.avgRating();\n        this.feedback = null;\n        this.comment.user = this.user.userId;\n        this.comment.timestamp = _Date$now();\n        this.comment.toId = this.courseId;\n        this.comment.cat = this.courseCat; //新增留言\n\n        this.$firestore.comments.add(this.comment); //更新評價分數\n\n        this.updateAvgRating();\n        Swal.fire({\n          type: \"success\",\n          title: \"\\u5DF2\\u6536\\u5230\\u60A8\\u7684\\u8A55\\u50F9\\uFF01\",\n          showConfirmButton: false,\n          timer: 1500\n        });\n      } else {\n        this.feedback = \"請選取課程評價分數再送出\";\n      }\n    },\n    updateComment: function updateComment(comment) {\n      this.comment.timestamp = moment(_Date$now()).format(\"l\");\n      this.$firestore.comments.doc(comment.id).update({\n        comment: comment.comment,\n        rating: comment.rating\n      });\n      this.updateAvgRating();\n      Swal.fire({\n        type: \"success\",\n        title: \"\\u5DF2\\u6536\\u5230\\u60A8\\u7684\\u8A55\\u50F9\\uFF01\",\n        showConfirmButton: false,\n        timer: 1500\n      });\n      this.inputShow = !this.inputShow;\n    },\n    avgRating: function avgRating() {\n      if (this.ratings.length === 0) {\n        this.avgStarRating = 0;\n      } else {\n        this.avgStarRating = _parseFloat((this.ratings.reduce(function (acc, cur) {\n          return cur + acc;\n        }) / this.ratings.length).toFixed(1));\n      } //更新progressbar\n\n\n      this.progressBar();\n    },\n    progressBar: function progressBar() {\n      var _this2 = this;\n\n      this.ratingsSorted = this.ratingsSorted.map(function (num, index) {\n        return _this2.ratings.filter(function (el) {\n          return el === index + 1;\n        }).length;\n      }).reverse();\n      this.ratingsSorted = this.ratingsSorted.map(function (el) {\n        return _this2.ratings.length === 0 ? 0 : (el / _this2.ratings.length * 100).toFixed(0);\n      });\n    },\n    updateAvgRating: function updateAvgRating() {\n      this.$firestore.course.update({\n        avgRating: this.avgStarRating\n      });\n    },\n    checkUserComment: function checkUserComment() {\n      var _this3 = this;\n\n      this.commentTo.forEach(function (comment) {\n        if (comment.user === _this3.user.userId) {\n          _this3.comment = comment;\n          _this3.inputShow = true;\n        }\n      });\n    }\n  },\n  created: function created() {\n    var _this4 = this;\n\n    var user = fb.auth().currentUser;\n\n    if (!user) {\n      this.user = \"無使用者\";\n    }\n\n    db.collection(\"users\").get().then(function (snapshot) {\n      snapshot.forEach(function (doc) {\n        var id = doc.data().userId;\n        var name = doc.data().name;\n        var img = doc.data().userImg; //確認current user身分\n\n        if (user && id === user.uid) {\n          _this4.user = doc.data();\n        } //確認每位留言者身分\n\n\n        _this4.commentTo.forEach(function (comment) {\n          if (id === comment.user) {\n            comment.img = img;\n            comment.name = name;\n          }\n        });\n      });\n      _this4.comments = _this4.commentTo;\n\n      _this4.checkUserComment();\n    });\n  }\n};",{"version":3,"sources":["Comments.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <div class=\"course-rating\">\n    <section class=\"course-rating\">\n      <div class=\"heading-tertiary--dark mb-sm\">課程評分</div>\n\n      <div class=\"course-rating__box\">\n        <div class=\"course-rating__avg-rating\">\n          <div class=\"course-rating__rating-figure\">{{avgStarRating}}</div>\n          <div class=\"course-rating__user\">\n            <i class=\"fas fa-user\"></i>\n            <div>{{ratings.length}}位學員評分</div>\n          </div>\n        </div>\n        <div class=\"course-rating__rating-bars\">\n          <div class=\"course-rating__rating-bar\" v-for=\"(percent,i) in ratingsSorted\">\n            <div class=\"course-rating__bar\">\n              <span class=\"course-rating__bar-progress\" :style=\"{width:percent+'%'}\"></span>\n            </div>\n\n            <div class=\"d-flex\">\n              <star-rating\n                :star-size=\"16\"\n                :read-only=\"true\"\n                :rounded-corners=\"true\"\n                :rating=\"(5-i)\"\n                :show-rating=\"false\"\n              ></star-rating>\n              <div class=\"course-rating__bar-num\">{{percent}} %</div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </section>\n    <div class=\"heading-tertiary--dark mb-sm\">評論</div>\n    <div class=\"user-comment\" v-if=\"!inputShow\">\n      <div class=\"user-comment__img-box\">\n        <img class=\"user-comment__img\" :src=\"user.userImg\" alt v-if=\"user!=='無使用者'\">\n        <img\n          class=\"user-comment__img\"\n          src=\"https://png2.pngtree.com/svg/20161215/9bc7bae28b.png\"\n          v-if=\"user=='無使用者'\"\n        >\n      </div>\n      <div class=\"user-comment__content\">\n        <div class=\"user-comment__info\">\n          <div v-if=\"user!=='無使用者'\">\n            <i class=\"fas fa-user\"></i>\n            {{user.name}}\n          </div>\n          <star-rating\n            class=\"user-comment__rating\"\n            v-model=\"comment.rating\"\n            :star-size=\"20\"\n            :rounded-corners=\"true\"\n            :show-rating=\"false\"\n            :read-only=\"user=='無使用者'\"\n          ></star-rating>\n        </div>\n\n        <form>\n          <div class=\"form__group\" style=\"margin-right:0px\">\n            <textarea\n              class=\"user-comment__textarea\"\n              v-model=\"comment.comment\"\n              :disabled=\"user=='無使用者'\"\n              placeholder=\"請開始你的表演\"\n            ></textarea>\n          </div>\n          <div class=\"form__group\">\n            <p class=\"text-center\" v-if=\"user=='無使用者'\">請先註冊或登入以進行評價</p>\n            <p>{{feedback}}</p>\n            <button\n              class=\"swal2-confirm swal2-styled\"\n              v-if=\"user!=='無使用者'&&inputstatus=='新留言'\"\n              @click.prevent=\"addComment();\"\n              style=\"display: inline-block; background-color: rgb(255, 87, 33); border-left-color: rgb(255, 87, 33); border-right-color: rgb(255, 87, 33);\"\n            >送出</button>\n            <button\n              class=\"swal2-confirm swal2-styled\"\n              v-if=\"user!=='無使用者'&&inputstatus=='編輯留言'\"\n              @click.prevent=\"updateComment(comment);\"\n              style=\"display: inline-block; background-color: rgb(255, 87, 33); border-left-color: rgb(255, 87, 33); border-right-color: rgb(255, 87, 33);\"\n            >確認修改</button>\n            <button\n              class=\"swal2-confirm swal2-styled\"\n              v-if=\"user!=='無使用者'&&inputstatus=='編輯留言'\"\n              @click.prevent=\"inputShow=!inputShow\"\n              style=\"display: inline-block; background-color: #cecece; border-left-color: rgb(255, 87, 33); border-right-color: rgb(255, 87, 33);\"\n            >取消</button>\n          </div>\n        </form>\n      </div>\n    </div>\n    <div class=\"d-flex-column\">\n      <div\n        class=\"user-comment\"\n        v-for=\"comment in comments\"\n        v-if=\"inputShow&&comment.comment\"\n        :class=\"{'user-first':comment.user=== user.userId}\"\n      >\n        <div class=\"d-flex\">\n          <div class=\"user-comment__img-box\">\n            <img class=\"user-comment__img\" :src=\"comment.img\">\n          </div>\n          <div class=\"user-comment__info d-block-phone\">\n            <div>\n              <i class=\"fas fa-user\"></i>\n              {{comment.name}}\n              <i class=\"far fa-clock\"></i>\n              {{time(comment.timestamp)}}\n            </div>\n\n            <star-rating\n              :rating=\"comment.rating\"\n              :star-size=\"20\"\n              :read-only=\"true\"\n              :rounded-corners=\"true\"\n              :show-rating=\"false\"\n            ></star-rating>\n          </div>\n        </div>\n        <div class=\"user-comment__content\" :class=\"{'user-current':comment.user=== user.userId}\">\n          <div class=\"user-comment__info d-none-phone\">\n            <div>\n              <i class=\"fas fa-user\"></i>\n              {{comment.name}}\n              <i class=\"far fa-clock\"></i>\n              {{time(comment.timestamp)}}\n            </div>\n\n            <star-rating\n              :rating=\"comment.rating\"\n              :star-size=\"20\"\n              :read-only=\"true\"\n              :rounded-corners=\"true\"\n              :show-rating=\"false\"\n            ></star-rating>\n          </div>\n          <p>{{comment.comment}}</p>\n          <button\n            class=\"swal2-confirm swal2-styled\"\n            v-if=\"comment.user=== user.userId\"\n            @click=\"inputShow =!inputShow;inputstatus='編輯留言'\"\n            style=\"display: inline-block; background-color: rgb(255, 87, 33); border-left-color: rgb(255, 87, 33); border-right-color: rgb(255, 87, 33);\"\n          >修改</button>\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\nimport { fb, db } from \"@/firebase/init\";\nimport StarRating from \"vue-star-rating\";\nimport Swal from \"sweetalert2\";\nimport moment from \"moment\";\n\nexport default {\n  components: {\n    StarRating\n  },\n  data() {\n    return {\n      avgStarRating: null,\n      ratings: [],\n      ratingsSorted: [0, 0, 0, 0, 0],\n      ratingsPercent: null,\n      user: {},\n      commentTo: [],\n      comments: [],\n      comment: {\n        comment: null,\n        rating: null,\n        user: null,\n        timestamp: null,\n        toId: null,\n        cat: null\n      },\n      feedback: null,\n      inputstatus: \"新留言\",\n      inputShow: false\n    };\n  },\n  props: [\"courseId\", \"courseCat\"],\n  firestore() {\n    return {\n      //更新課程評價時使用\n      course: {\n        ref: db.collection(\"courses\").doc(this.courseId),\n        resolve: data => {\n          data.forEach(doc => this.ratings.push(doc.rating));\n          //計算初始平均評價\n          this.avgRating();\n        }\n      },\n      //更新評價時使用\n      comments: db.collection(\"comments\"),\n      commentTo: {\n        ref: db.collection(\"comments\").where(\"toId\", \"==\", this.courseId),\n        resolve: data => {\n          data.forEach(doc => this.ratings.push(doc.rating));\n          //計算初始平均評價\n          this.avgRating();\n        }\n      }\n    };\n  },\n  methods: {\n    time(num) {\n      return moment(num).format(\"YYYY/MM/DD HH:mm\");\n    },\n    addComment() {\n      if (this.comment.rating) {\n        //新增評價分數\n        this.ratings.push(this.comment.rating);\n        //計算平均評價\n        this.avgRating();\n        this.feedback = null;\n        this.comment.user = this.user.userId;\n        this.comment.timestamp = Date.now();\n        this.comment.toId = this.courseId;\n        this.comment.cat = this.courseCat;\n        //新增留言\n        this.$firestore.comments.add(this.comment);\n        //更新評價分數\n        this.updateAvgRating();\n        Swal.fire({\n          type: \"success\",\n          title: `已收到您的評價！`,\n          showConfirmButton: false,\n          timer: 1500\n        });\n      } else {\n        this.feedback = \"請選取課程評價分數再送出\";\n      }\n    },\n    updateComment(comment) {\n      this.comment.timestamp = moment(Date.now()).format(\"l\");\n      this.$firestore.comments.doc(comment.id).update({\n        comment: comment.comment,\n        rating: comment.rating\n      });\n      this.updateAvgRating();\n      Swal.fire({\n        type: \"success\",\n        title: `已收到您的評價！`,\n        showConfirmButton: false,\n        timer: 1500\n      });\n      this.inputShow = !this.inputShow;\n    },\n    avgRating() {\n      if (this.ratings.length === 0) {\n        this.avgStarRating = 0;\n      } else {\n        this.avgStarRating = parseFloat(\n          (\n            this.ratings.reduce((acc, cur) => cur + acc) / this.ratings.length\n          ).toFixed(1)\n        );\n      }\n      //更新progressbar\n      this.progressBar();\n    },\n    progressBar() {\n      this.ratingsSorted = this.ratingsSorted\n        .map((num, index) => this.ratings.filter(el => el === index + 1).length)\n        .reverse();\n      this.ratingsSorted = this.ratingsSorted.map(el =>\n        this.ratings.length === 0\n          ? 0\n          : ((el / this.ratings.length) * 100).toFixed(0)\n      );\n    },\n\n    updateAvgRating() {\n      this.$firestore.course.update({\n        avgRating: this.avgStarRating\n      });\n    },\n    checkUserComment() {\n      this.commentTo.forEach(comment => {\n        if (comment.user === this.user.userId) {\n          this.comment = comment;\n          this.inputShow = true;\n        }\n      });\n    }\n  },\n\n  created() {\n    let user = fb.auth().currentUser;\n    if (!user) {\n      this.user = \"無使用者\";\n    }\n    db.collection(\"users\")\n      .get()\n      .then(snapshot => {\n        snapshot.forEach(doc => {\n          let id = doc.data().userId;\n          let name = doc.data().name;\n          let img = doc.data().userImg;\n          //確認current user身分\n          if (user && id === user.uid) {\n            this.user = doc.data();\n          }\n          //確認每位留言者身分\n          this.commentTo.forEach(comment => {\n            if (id === comment.user) {\n              comment.img = img;\n              comment.name = name;\n            }\n          });\n        });\n        this.comments = this.commentTo;\n        this.checkUserComment();\n      });\n  }\n};\n</script>"],"sourceRoot":"src/components"}]}