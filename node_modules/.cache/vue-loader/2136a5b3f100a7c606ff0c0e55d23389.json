{"remainingRequest":"/Users/huangpei-yu/Front-Gym/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/huangpei-yu/Front-Gym/src/components/Comments.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/huangpei-yu/Front-Gym/src/components/Comments.vue","mtime":1582668128540},{"path":"/Users/huangpei-yu/Front-Gym/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/huangpei-yu/Front-Gym/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/huangpei-yu/Front-Gym/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/huangpei-yu/Front-Gym/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/huangpei-yu/Front-Gym/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport { db } from \"@/firebase/init\";\nimport StarRating from \"vue-star-rating\";\nimport Swal from \"sweetalert2\";\nimport moment from \"moment\";\n\nexport default {\n  components: {\n    StarRating\n  },\n  data() {\n    return {\n      avgStarRating: null,\n      ratings: [],\n      ratingsSorted: [0, 0, 0, 0, 0],\n      ratingsPercent: null,\n      user: {},\n      commentTo: [],\n      comments: [],\n      comment: {\n        comment: null,\n        rating: null,\n        user: null,\n        timestamp: null,\n        toId: null,\n        cat: null\n      },\n      feedback: null,\n      inputstatus: \"新留言\",\n      inputShow: false\n    };\n  },\n  props: [\"courseId\", \"courseCat\"],\n  firestore() {\n    return {\n      //更新課程評價時使用\n      course: {\n        ref: db.collection(\"courses\").doc(this.courseId),\n        resolve: data => {\n          data.forEach(doc => this.ratings.push(doc.rating));\n          //計算初始平均評價\n          this.avgRating();\n        }\n      },\n      //更新評價時使用\n      comments: db.collection(\"comments\"),\n      commentTo: {\n        ref: db.collection(\"comments\").where(\"toId\", \"==\", this.courseId),\n        resolve: data => {\n          data.forEach(doc => this.ratings.push(doc.rating));\n          //計算初始平均評價\n          this.avgRating();\n        }\n      }\n    };\n  },\n  methods: {\n    time(num) {\n      return moment(num).format(\"YYYY/MM/DD HH:mm\");\n    },\n    addComment() {\n      if (this.comment.rating) {\n        //新增評價分數\n        this.ratings.push(this.comment.rating);\n        //計算平均評價\n        this.avgRating();\n        this.feedback = null;\n        this.comment.user = this.user.userId;\n        this.comment.timestamp = Date.now();\n        this.comment.toId = this.courseId;\n        this.comment.cat = this.courseCat;\n        //新增留言\n        this.$firestore.comments.add(this.comment);\n        //更新評價分數\n        this.updateAvgRating();\n        Swal.fire({\n          type: \"success\",\n          title: `已收到您的評價！`,\n          showConfirmButton: false,\n          timer: 1500\n        });\n      } else {\n        this.feedback = \"請選取課程評價分數再送出\";\n      }\n    },\n    updateComment(comment) {\n      this.comment.timestamp = moment(Date.now()).format(\"l\");\n      this.$firestore.comments.doc(comment.id).update({\n        comment: comment.comment,\n        rating: comment.rating\n      });\n      this.updateAvgRating();\n      Swal.fire({\n        type: \"success\",\n        title: `已收到您的評價！`,\n        showConfirmButton: false,\n        timer: 1500\n      });\n      this.inputShow = !this.inputShow;\n    },\n    avgRating() {\n      if (this.ratings.length === 0) {\n        this.avgStarRating = 0;\n      } else {\n        this.avgStarRating = parseFloat(\n          (\n            this.ratings.reduce((acc, cur) => cur + acc) / this.ratings.length\n          ).toFixed(1)\n        );\n      }\n      //更新progressbar\n      this.progressBar();\n    },\n    progressBar() {\n      this.ratingsSorted = this.ratingsSorted\n        .map((num, index) => this.ratings.filter(el => el === index + 1).length)\n        .reverse();\n      this.ratingsSorted = this.ratingsSorted.map(el =>\n        this.ratings.length === 0\n          ? 0\n          : ((el / this.ratings.length) * 100).toFixed(0)\n      );\n    },\n\n    updateAvgRating() {\n      this.$firestore.course.update({\n        avgRating: this.avgStarRating\n      });\n    },\n    checkUserComment() {\n      this.commentTo.forEach(comment => {\n        if (comment.user === this.user.userId) {\n          this.comment = comment;\n          this.inputShow = true;\n        }\n      });\n    }\n  },\n\n  created() {\n    // let user = fb.auth().currentUser;\n    // if (!user) {\n    //   this.user = \"無使用者\";\n    // }\n    // db.collection(\"users\")\n    //   .get()\n    //   .then(snapshot => {\n    //     snapshot.forEach(doc => {\n    //       let id = doc.data().userId;\n    //       let name = doc.data().name;\n    //       let img = doc.data().userImg;\n    //       //確認current user身分\n    //       if (user && id === user.uid) {\n    //         this.user = doc.data();\n    //       }\n    //       //確認每位留言者身分\n    //       this.commentTo.forEach(comment => {\n    //         if (id === comment.user) {\n    //           comment.img = img;\n    //           comment.name = name;\n    //         }\n    //       });\n    //     });\n    //     this.comments = this.commentTo;\n    //     this.checkUserComment();\n    //   });\n  }\n};\n",{"version":3,"sources":["Comments.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAwJA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"Comments.vue","sourceRoot":"src/components","sourcesContent":["<template>\n  <div class=\"course-rating\">\n    <section class=\"course-rating\">\n      <div class=\"heading-tertiary--dark mb-sm\">課程評分</div>\n\n      <div class=\"course-rating__box\">\n        <div class=\"course-rating__avg-rating\">\n          <div class=\"course-rating__rating-figure\">{{avgStarRating}}</div>\n          <div class=\"course-rating__user\">\n            <i class=\"fas fa-user\"></i>\n            <div>{{ratings.length}}位學員評分</div>\n          </div>\n        </div>\n        <div class=\"course-rating__rating-bars\">\n          <div class=\"course-rating__rating-bar\" v-for=\"(percent,i) in ratingsSorted\">\n            <div class=\"course-rating__bar\">\n              <span class=\"course-rating__bar-progress\" :style=\"{width:percent+'%'}\"></span>\n            </div>\n\n            <div class=\"d-flex\">\n              <star-rating\n                :star-size=\"16\"\n                :read-only=\"true\"\n                :rounded-corners=\"true\"\n                :rating=\"(5-i)\"\n                :show-rating=\"false\"\n              ></star-rating>\n              <div class=\"course-rating__bar-num\">{{percent}} %</div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </section>\n    <div class=\"heading-tertiary--dark mb-sm\">評論</div>\n    <div class=\"user-comment\" v-if=\"!inputShow\">\n      <div class=\"user-comment__img-box\">\n        <img class=\"user-comment__img\" :src=\"user.userImg\" alt v-if=\"user!=='無使用者'\">\n        <img\n          class=\"user-comment__img\"\n          src=\"https://png2.pngtree.com/svg/20161215/9bc7bae28b.png\"\n          v-if=\"user=='無使用者'\"\n        >\n      </div>\n      <div class=\"user-comment__content\">\n        <div class=\"user-comment__info\">\n          <div v-if=\"user!=='無使用者'\">\n            <i class=\"fas fa-user\"></i>\n            {{user.name}}\n          </div>\n          <star-rating\n            class=\"user-comment__rating\"\n            v-model=\"comment.rating\"\n            :star-size=\"20\"\n            :rounded-corners=\"true\"\n            :show-rating=\"false\"\n            :read-only=\"user=='無使用者'\"\n          ></star-rating>\n        </div>\n\n        <form>\n          <div class=\"form__group\" style=\"margin-right:0px\">\n            <textarea\n              class=\"user-comment__textarea\"\n              v-model=\"comment.comment\"\n              :disabled=\"user=='無使用者'\"\n              placeholder=\"請開始你的表演\"\n            ></textarea>\n          </div>\n          <div class=\"form__group\">\n            <p class=\"text-center\" v-if=\"user=='無使用者'\">請先註冊或登入以進行評價</p>\n            <p>{{feedback}}</p>\n            <button\n              class=\"swal2-confirm swal2-styled\"\n              v-if=\"user!=='無使用者'&&inputstatus=='新留言'\"\n              @click.prevent=\"addComment();\"\n              style=\"display: inline-block; background-color: rgb(255, 87, 33); border-left-color: rgb(255, 87, 33); border-right-color: rgb(255, 87, 33);\"\n            >送出</button>\n            <button\n              class=\"swal2-confirm swal2-styled\"\n              v-if=\"user!=='無使用者'&&inputstatus=='編輯留言'\"\n              @click.prevent=\"updateComment(comment);\"\n              style=\"display: inline-block; background-color: rgb(255, 87, 33); border-left-color: rgb(255, 87, 33); border-right-color: rgb(255, 87, 33);\"\n            >確認修改</button>\n            <button\n              class=\"swal2-confirm swal2-styled\"\n              v-if=\"user!=='無使用者'&&inputstatus=='編輯留言'\"\n              @click.prevent=\"inputShow=!inputShow\"\n              style=\"display: inline-block; background-color: #cecece; border-left-color: rgb(255, 87, 33); border-right-color: rgb(255, 87, 33);\"\n            >取消</button>\n          </div>\n        </form>\n      </div>\n    </div>\n    <div class=\"d-flex-column\">\n      <div\n        class=\"user-comment\"\n        v-for=\"comment in comments\"\n        v-if=\"inputShow&&comment.comment\"\n        :class=\"{'user-first':comment.user=== user.userId}\"\n      >\n        <div class=\"d-flex\">\n          <div class=\"user-comment__img-box\">\n            <img class=\"user-comment__img\" :src=\"comment.img\">\n          </div>\n          <div class=\"user-comment__info d-block-phone\">\n            <div>\n              <i class=\"fas fa-user\"></i>\n              {{comment.name}}\n              <i class=\"far fa-clock\"></i>\n              {{time(comment.timestamp)}}\n            </div>\n\n            <star-rating\n              :rating=\"comment.rating\"\n              :star-size=\"20\"\n              :read-only=\"true\"\n              :rounded-corners=\"true\"\n              :show-rating=\"false\"\n            ></star-rating>\n          </div>\n        </div>\n        <div class=\"user-comment__content\" :class=\"{'user-current':comment.user=== user.userId}\">\n          <div class=\"user-comment__info d-none-phone\">\n            <div>\n              <i class=\"fas fa-user\"></i>\n              {{comment.name}}\n              <i class=\"far fa-clock\"></i>\n              {{time(comment.timestamp)}}\n            </div>\n\n            <star-rating\n              :rating=\"comment.rating\"\n              :star-size=\"20\"\n              :read-only=\"true\"\n              :rounded-corners=\"true\"\n              :show-rating=\"false\"\n            ></star-rating>\n          </div>\n          <p>{{comment.comment}}</p>\n          <button\n            class=\"swal2-confirm swal2-styled\"\n            v-if=\"comment.user=== user.userId\"\n            @click=\"inputShow =!inputShow;inputstatus='編輯留言'\"\n            style=\"display: inline-block; background-color: rgb(255, 87, 33); border-left-color: rgb(255, 87, 33); border-right-color: rgb(255, 87, 33);\"\n          >修改</button>\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\nimport { db } from \"@/firebase/init\";\nimport StarRating from \"vue-star-rating\";\nimport Swal from \"sweetalert2\";\nimport moment from \"moment\";\n\nexport default {\n  components: {\n    StarRating\n  },\n  data() {\n    return {\n      avgStarRating: null,\n      ratings: [],\n      ratingsSorted: [0, 0, 0, 0, 0],\n      ratingsPercent: null,\n      user: {},\n      commentTo: [],\n      comments: [],\n      comment: {\n        comment: null,\n        rating: null,\n        user: null,\n        timestamp: null,\n        toId: null,\n        cat: null\n      },\n      feedback: null,\n      inputstatus: \"新留言\",\n      inputShow: false\n    };\n  },\n  props: [\"courseId\", \"courseCat\"],\n  firestore() {\n    return {\n      //更新課程評價時使用\n      course: {\n        ref: db.collection(\"courses\").doc(this.courseId),\n        resolve: data => {\n          data.forEach(doc => this.ratings.push(doc.rating));\n          //計算初始平均評價\n          this.avgRating();\n        }\n      },\n      //更新評價時使用\n      comments: db.collection(\"comments\"),\n      commentTo: {\n        ref: db.collection(\"comments\").where(\"toId\", \"==\", this.courseId),\n        resolve: data => {\n          data.forEach(doc => this.ratings.push(doc.rating));\n          //計算初始平均評價\n          this.avgRating();\n        }\n      }\n    };\n  },\n  methods: {\n    time(num) {\n      return moment(num).format(\"YYYY/MM/DD HH:mm\");\n    },\n    addComment() {\n      if (this.comment.rating) {\n        //新增評價分數\n        this.ratings.push(this.comment.rating);\n        //計算平均評價\n        this.avgRating();\n        this.feedback = null;\n        this.comment.user = this.user.userId;\n        this.comment.timestamp = Date.now();\n        this.comment.toId = this.courseId;\n        this.comment.cat = this.courseCat;\n        //新增留言\n        this.$firestore.comments.add(this.comment);\n        //更新評價分數\n        this.updateAvgRating();\n        Swal.fire({\n          type: \"success\",\n          title: `已收到您的評價！`,\n          showConfirmButton: false,\n          timer: 1500\n        });\n      } else {\n        this.feedback = \"請選取課程評價分數再送出\";\n      }\n    },\n    updateComment(comment) {\n      this.comment.timestamp = moment(Date.now()).format(\"l\");\n      this.$firestore.comments.doc(comment.id).update({\n        comment: comment.comment,\n        rating: comment.rating\n      });\n      this.updateAvgRating();\n      Swal.fire({\n        type: \"success\",\n        title: `已收到您的評價！`,\n        showConfirmButton: false,\n        timer: 1500\n      });\n      this.inputShow = !this.inputShow;\n    },\n    avgRating() {\n      if (this.ratings.length === 0) {\n        this.avgStarRating = 0;\n      } else {\n        this.avgStarRating = parseFloat(\n          (\n            this.ratings.reduce((acc, cur) => cur + acc) / this.ratings.length\n          ).toFixed(1)\n        );\n      }\n      //更新progressbar\n      this.progressBar();\n    },\n    progressBar() {\n      this.ratingsSorted = this.ratingsSorted\n        .map((num, index) => this.ratings.filter(el => el === index + 1).length)\n        .reverse();\n      this.ratingsSorted = this.ratingsSorted.map(el =>\n        this.ratings.length === 0\n          ? 0\n          : ((el / this.ratings.length) * 100).toFixed(0)\n      );\n    },\n\n    updateAvgRating() {\n      this.$firestore.course.update({\n        avgRating: this.avgStarRating\n      });\n    },\n    checkUserComment() {\n      this.commentTo.forEach(comment => {\n        if (comment.user === this.user.userId) {\n          this.comment = comment;\n          this.inputShow = true;\n        }\n      });\n    }\n  },\n\n  created() {\n    // let user = fb.auth().currentUser;\n    // if (!user) {\n    //   this.user = \"無使用者\";\n    // }\n    // db.collection(\"users\")\n    //   .get()\n    //   .then(snapshot => {\n    //     snapshot.forEach(doc => {\n    //       let id = doc.data().userId;\n    //       let name = doc.data().name;\n    //       let img = doc.data().userImg;\n    //       //確認current user身分\n    //       if (user && id === user.uid) {\n    //         this.user = doc.data();\n    //       }\n    //       //確認每位留言者身分\n    //       this.commentTo.forEach(comment => {\n    //         if (id === comment.user) {\n    //           comment.img = img;\n    //           comment.name = name;\n    //         }\n    //       });\n    //     });\n    //     this.comments = this.commentTo;\n    //     this.checkUserComment();\n    //   });\n  }\n};\n</script>"]}]}